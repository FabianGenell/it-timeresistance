{%- liquid
  assign overlay_opacity = meganav_settings.overlay_opacity | divided_by: 100.0
  assign text_position = meganav_settings.text_position | split: '_'
  assign horizontal_position = text_position | first
  assign vertical_position = text_position | last
-%}

{%- capture meganav_primary -%}
  <div class="meganav__primary">
    {% render 'meganav-nav' with meganav_settings: meganav_settings, link: link %}
  </div>
{%- endcapture -%}

{%- capture meganav_secondary -%}
  {%- liquid
    assign image = meganav_settings.image
    assign link = meganav_settings.link
    assign promo_text = meganav_settings.promo_text
    assign link_text = meganav_settings.link_text
    assign focal_point = meganav_settings.focal_point
    assign button_style = meganav_settings.button_style

    assign link_key = 'link'

    assign promo_height = meganav_settings.promo_height
    assign promo_width = meganav_settings.promo_width

    assign show_promo = meganav_settings.show_promo

    if show_promo 
      assign promos = 1
    elsif meganav_type == 'meganav_double_banner'
      assign promos = 2
    endif
  -%}


  {%- for i in (1..promos) -%}
    {%- liquid
      assign sizes = '(max-width: 1200px) 60vw, 700px'
      if meganav_type == 'meganav_double_banner'
        assign sizes = '(max-width: 1200px) 50vw, 700px'

        assign image_key = 'image_' | append: i
        assign link_key = 'link_' | append: i
        assign promo_text_key = 'promo_text_' | append: i
        assign link_text_key = 'link_text_' | append: i
        assign focal_point_key = 'focal_point_' | append: i
        assign button_style_key = 'button_style_' | append: i

        assign image = meganav_settings[image_key]
        assign link = meganav_settings[link_key]
        assign promo_text = meganav_settings[promo_text_key]
        assign link_text = meganav_settings[link_text_key]
        assign focal_point = meganav_settings[focal_point_key]
        assign button_style = meganav_settings[button_style_key]

        assign promo_height = 400
        assign promo_width = 800
      endif
    -%}
    <div class="meganav__secondary">
      <div
        {{ wrapping_attributes }}
        class="meganav-promo"
        style="
          --text-horizontal-position: {{ horizontal_position }};
          --text-vertical-position: {{ vertical_position }};
          --min-promo-height: {{ promo_height }}px;
        "
      >
        {%- if link != blank -%}
          <a href="{{ link }}" class="meganav__promo-image-link">
        {%- endif -%}

        {%- render 'image', 
          image: image, 
          src_width: promo_width, 
          class: "img-fit",
          widths: '300, 600, 900, 1200, 1500',
          sizes: sizes,
          lazy_type: 'load'
        -%}
        {%- if link != blank -%}
          </a>
        {%- endif -%}

        <div class="meganav__secondary-promo-overlay"></div>
        <div class="meganav__secondary-promo-text">
          {% unless promo_text == blank %}
            <h3 class="ff-heading fs-heading-4-base meganav__secondary-promo-text-heading mb-2">{{ promo_text }}</h3>
          {% endunless %}
          {% if link and link != blank %}
            {%- render 'button-block-v2' with
              label: link_text,
              link: link,
              button_style: button_style,
              is_overlay: true,
              is_x_small: true,
              allow_linkless: true,
              settings_key: link_key,
              settings_object: meganav_settings
            -%}
          {% endif %}
        </div>
      </div>
    </div>
  {%- endfor -%}

{%- endcapture -%}

<div
  class="
    meganav
    {% if meganav_settings.show_promo %}
      meganav--has-promo
      meganav--promo-position-{{ meganav_settings.secondary_position }}
    {% endif %}
    {% if settings.enable_section_animations %}
      animation
      animation--dropdown
    {% endif %}
  "
  id="{{ menu_id }}"
  data-submenu
  data-hidden="true"
  data-menu-handle="{{ menu }}"
  data-meganav-type="{{ meganav_type }}"
  {% unless meganav_type == 'full_width_meganav' or meganav_type == 'meganav_double_banner' %}
    data-align-to-trigger="true"
  {% endunless %}
  style="
      --column-count: {{ meganav_settings.column_count }};
      --columns-width: {{ meganav_settings.columns_width }}px;
      {% unless meganav_type == 'full_width_meganav' %}--columns-width: {{ meganav_settings.columns_width }}px;{% endunless %}
      --secondary-width: {{ meganav_settings.promo_width }}px;
      --color-promo-text: {{ meganav_settings.text_color }};
      --color-text-overlay-button: {{ meganav_settings.button_text_color | default: meganav_settings.text_color }};
      --color-background-overlay-button: {{ meganav_settings.button_background_color | default: meganav_settings.text_color }};
      --color-background-overlay-button-hover: {{ meganav_settings.button_hover_background_color | default: meganav_settings.button_background_color | default: meganav_settings.text_color }};
      --color-background-overlay-outline-button-alpha:
    {{ meganav_settings.button_background_color | default: meganav_settings.text_color | color_modify: 'alpha', 0.1 }};
      --overlay-background: {{ meganav_settings.color_overlay }};
      {% if meganav_settings.color_overlay_gradient != blank %}
        --overlay-background-gradient: {{ meganav_settings.color_overlay_gradient }};
      {% endif %}
      --overlay-opacity: {{ overlay_opacity }};
  "
  {{ shopify_attributes }}
>
  {% if meganav_type == 'meganav_double_banner' %}
    <div class="w-full grid grid-cols-2 min-h-80">
      {{ meganav_secondary }}
    </div>
  {%- else -%}
    <div class="meganav__inner">
      {% if meganav_settings.show_promo and meganav_settings.secondary_position == 'left' %}
        {{ meganav_secondary }}
      {% endif %}
      {{ meganav_primary }}
      {% if meganav_settings.show_promo and meganav_settings.secondary_position == 'right' %}
        {{ meganav_secondary }}
      {% endif %}
    </div>
  {% endif %}
</div>
