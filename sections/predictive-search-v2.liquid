<!-- File: sections/predictive-search-v2.liquid -->
{%- if section.settings.enable_section_style -%}
  {%- render 'section-style', section: section -%}
{%- endif -%}
{%- liquid
  assign total_results = predictive_search.resources.products.size | plus: predictive_search.resources.queries.size | plus: predictive_search.resources.collections.size | plus: predictive_search.resources.pages.size | plus: predictive_search.resources.articles.size

  assign class = ''

  if predictive_search.resources.products.size > 0
    assign class = 'grid md:grid-cols-[1fr_3fr] gap-4'
  endif
-%}

{%- if predictive_search.performed -%}
  {%- if total_results > 0 -%}
    <div class="{{ class }}">
      <div class="">
        {%- if predictive_search.resources.queries.size > 0 -%}
          <h4 class="quick-search__header ff-body text-sm">
            <span class="t-subdued">{{ 'search.suggestions' | t }}</span>
          </h4>
          <ul class="quick-search__suggested-queries-list list-reset">
            {%- for query in predictive_search.resources.queries -%}
              <li class="quick-search__suggested-queries-list-item">
                <a href="{{ query.url }}" class="quick-search__result ff-body fs-body-50">
                  <p
                    class="quick-search__result-details quick-search__result-details--query"
                    aria-label="{{ query.text }}"
                  >
                    {{ query.styled_text }}
                  </p>
                </a>
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}

        {%- if predictive_search.resources.collections.size > 0 -%}
          <h4 class="quick-search__header ff-body text-sm">
            <span class="t-subdued">{{ 'search.headings.collections' | t }}</span>
          </h4>

          {%- for collection in predictive_search.resources.collections -%}
            <a class="quick-search__result" href="{{ collection.url }}">
              <div class="quick-search__result-heading whitespace-normal ff-body fs-body-50">
                {{ collection.title }}
              </div>
            </a>
          {%- endfor -%}
        {%- endif -%}

        {%- if predictive_search.resources.pages.size > 0 -%}
          <h4 class="quick-search__header ff-body text-sm">
            <span class="t-subdued">{{ 'search.headings.pages' | t }}</span>
          </h4>

          {%- for page in predictive_search.resources.pages -%}
            <a class="quick-search__result" href="{{ page.url }}">
              <div class="quick-search__result-heading whitespace-normal ff-body fs-body-50">
                {{ page.title }}
              </div>
            </a>
          {%- endfor -%}
        {%- endif -%}

        {%- if predictive_search.resources.articles.size > 0 -%}
          <h4 class="quick-search__header ff-body text-sm">
            <span class="t-subdued">{{ 'search.headings.articles' | t }}</span>
          </h4>

          {%- for article in predictive_search.resources.articles -%}
            <a class="quick-search__result" href="{{ article.url }}">
              <div class="quick-search__result-heading whitespace-normal ff-body fs-body-50">
                {{ article.title }}
              </div>
            </a>
          {%- endfor -%}
        {%- endif -%}
      </div>
      <div class="flex flex-col">
        {%- if predictive_search.resources.products.size > 0 -%}
          <h4 class="quick-search__header ff-body text-base leading-[20px]">
            <span class="t-subdued">{{ 'search.headings.products' | t }}</span>
          </h4>

          <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
            {%- assign variants_displayed = 0 -%}
            {%- for product in predictive_search.resources.products -%}
              {% for variant in product.variants %}
                {%- if variants_displayed < 6 -%}
                  {%- liquid
                    assign product_title = product.metafields.custom.short_product_name | default: product.title
                  -%}
                  <div class="relative group/variant rounded-lg transition-colors duration-200 overflow-hidden">
                    <div class="absolute top-2 left-2 flex gap-1 z-20">
                      {%- render 'product-badges', prod: product -%}
                    </div>
                    {%- render 'button-wishlist',
                      prod: product,
                      var: variant,
                      class: 'absolute top-2 right-2 w-5 h-5 z-20 opacity-0 group-hover/variant:opacity-100 transition-opacity duration-200'
                    -%}
                    <a
                      href="{{ variant.url }}"
                      class="block p-3 h-full"
                    >
                      <div class="media aspect-square w-full mb-3 overflow-hidden rounded-md bg-gray-50">
                        {%- liquid
                          assign first_image = variant.featured_image | default: product.featured_image
                          assign second_image = null
                          
                          if variant.featured_media
                            assign initial_variant_media_index = variant.featured_media.position | minus: 1
                            assign next_variant_media_index = initial_variant_media_index | plus: 1
                            assign second_image = product.media[next_variant_media_index].preview_image
                          else
                            assign second_image = product.images[1]
                          endif
                        -%}
                        
                        {%- render 'image',
                          image: first_image,
                          src_width: 450,
                          widths: '150, 300, 450',
                          sizes: '(max-width: 768px) 50vw,(max-width: 1200px) 25vw, 300px',
                          class: 'img-fit transition-opacity duration-300 group-hover/variant:opacity-0',
                          lazy_load: false
                        -%}
                        
                        {%- if second_image -%}
                          {%- render 'image',
                            image: second_image,
                            src_width: 450,
                            widths: '150, 300, 450',
                            sizes: '(max-width: 768px) 50vw,(max-width: 1200px) 25vw, 300px',
                            class: 'img-fit absolute inset-0 opacity-0 group-hover/variant:opacity-100 transition-opacity duration-300',
                            lazy_load: false
                          -%}
                        {%- endif -%}
                      </div>
                      <div class="flex flex-col gap-1 text-center">
                        <h5 class="leading-tight line-clamp-2" style="font-size: 14px;">{{ product_title }}</h5>
                        {%- if product.compare_at_price > product.price -%}
                          <div class="flex items-center justify-center gap-1">
                            <span class="text-gray-500 line-through" style="font-size: 18px;">
                              {{- product.compare_at_price | money -}}
                            </span>
                            <span class="text-red-600" style="font-size: 18px;">
                              {{- variant.price | money -}}
                            </span>
                          </div>
                        {%- else -%}
                          <span style="font-size: 18px;">{{ variant.price | money }}</span>
                        {%- endif -%}
                      </div>
                    </a>
                  </div>
                  {%- assign variants_displayed = variants_displayed | plus: 1 -%}
                {% endif %}
              {% endfor %}
            {%- endfor -%}
          </div>

          <div class="flex h-full justify-center items-end">
            <button
              class="btn btn--primary btn--full btn--small mt-6 "
              type="submit"
            >
              View all
              {% render 'icon' with 'arrow-short', class: 'size-3 ml-2' %}
            </button>
          </div>
        {%- endif -%}
      </div>
    </div>
  {%- else -%}
    <h4 class="quick-search__no-results-header ff-body fs-body-200">
      {{ 'search.no_results_html' | t: terms: predictive_search.terms }}
    </h4>
    <p class="quick-search__no-results t-subdued">{{ 'search.check_spelling' | t }}</p>
  {%- endif -%}
{%- endif -%}
